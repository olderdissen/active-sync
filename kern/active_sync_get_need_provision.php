<?
function active_sync_get_need_provision($request)
	{
	################################################################################
	# get settings
	################################################################################

	$settings_server = active_sync_get_settings(DAT_DIR . "/login.data");

	$settings_client = active_sync_get_settings(DAT_DIR . "/" . $request["AuthUser"] . "/" . $request["DeviceId"] . ".sync");

	################################################################################
	# server has no policy
	################################################################################

	if(isset($settings_server["Policy"]["PolicyKey"]) === false)
		{
		################################################################################
		# device has no policy
		################################################################################

		if(isset($settings_client["PolicyKey"]) === false)
			{
			return(0);
			}

		################################################################################
		# device has policy
		################################################################################

		if(isset($settings_client["PolicyKey"]) === true)
			{
			return(1);
			}
		}

	################################################################################
	# server has policy
	################################################################################

	if(isset($settings_server["Policy"]["PolicyKey"]) === true)
		{
		################################################################################
		# device has no policy
		################################################################################

		if(isset($settings_client["PolicyKey"]) === false)
			{
			return(1);
			}

		################################################################################
		# device has policy
		################################################################################

		if(isset($settings_client["PolicyKey"]) === true)
			{
			################################################################################
			# policy is not up to date
			################################################################################

			if($settings_server["Policy"]["PolicyKey"] != $settings_client["PolicyKey"])
				{
				return(1);
				}

			################################################################################
			# policy is up to date
			################################################################################

			if($settings_server["Policy"]["PolicyKey"] == $settings_client["PolicyKey"])
				{
				################################################################################
				# device do not want to update policy
				################################################################################

				if($request["PolicyKey"] != 0)
					{
					################################################################################
					# ...
					################################################################################

					if($request["PolicyKey"] != $settings_server["Policy"]["PolicyKey"])
						{
						return(1);
						}

					################################################################################
					# ...
					################################################################################

					if($request["PolicyKey"] == $settings_server["Policy"]["PolicyKey"])
						{
						return(0);
						}
					}

				################################################################################
				# device want to update policy
				################################################################################

				if($request["PolicyKey"] == 0)
					{
					################################################################################
					# ...
					################################################################################

					if($request["Cmd"] != "Ping")
						{
						return(1);
						}

					################################################################################
					# ...
					################################################################################

					if($request["Cmd"] == "Ping")
						{
						return(0); # PolicyKey of Ping is always 0 ... policy was requested by device
						}
					}
				}
			}
		}
	}
?>
